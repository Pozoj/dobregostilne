GEvent.clearListeners(google_map);
var google_map_latlng_bounds = new GLatLngBounds();
<% 
@spots.each do |spot| 
idx = String.rand(3)
-%>
google_map_latlng_bounds.extend(new GLatLng(<%= spot.lat %>,<%= spot.lng %>));
function google_map_marker_<%= idx %>_infowindow_function(){google_map_marker_<%= idx %>.openInfoWindowHtml("<%= escape_javascript render(:partial => "info", :locals => {:spot => spot}) %>");}
google_map_marker_<%= idx %>=new GMarker(new GLatLng(<%= spot.lat %>,<%= spot.lng %>));
GEvent.addListener(google_map_marker_<%= idx %>,'click',function(){google_map_marker_<%= idx %>_infowindow_function()});
google_map.addOverlay(google_map_marker_<%= idx %>);
<% 
end 
-%>
var zoom;
zoom = google_map.getBoundsZoomLevel(google_map_latlng_bounds);
if (zoom > 8) zoom = zoom - (zoom-11);
google_map.setCenter(google_map_latlng_bounds.getCenter(), zoom);
GEvent.addListener(google_map, "moveend", function() {
  new Ajax.Updater('spots_list', '/spots_in_area', {
    parameters: { zoom: google_map.getZoom(), center_y: google_map.getCenter().y, center_x: google_map.getCenter().x }
  });
});